version: '3.8'

# Production Docker Compose configuration
# Usage: docker-compose -f docker-compose.prod.yml up -d

services:
  # PostgreSQL with replication-ready config
  postgres:
    image: postgres:15-alpine
    container_name: vokg-postgres-prod
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - vokg-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # Neo4j production config
  neo4j:
    image: neo4j:5.13-enterprise
    container_name: vokg-neo4j-prod
    environment:
      NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PASSWORD}
      NEO4J_PLUGINS: '["apoc","graph-data-science"]'
      NEO4J_dbms_memory_heap_initial__size: 1g
      NEO4J_dbms_memory_heap_max__size: 4g
      NEO4J_dbms_memory_pagecache_size: 2g
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - vokg-network
    deploy:
      resources:
        limits:
          memory: 6G
        reservations:
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # Redis with persistence
  redis:
    image: redis:7-alpine
    container_name: vokg-redis-prod
    command: >
      redis-server
      --appendonly yes
      --maxmemory 2gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - vokg-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # MinIO with data persistence
  minio:
    image: minio/minio:latest
    container_name: vokg-minio-prod
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY_ID}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_ACCESS_KEY}
    volumes:
      - minio_data:/data
    networks:
      - vokg-network
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: always

  # API Gateway with Gunicorn
  api:
    build:
      context: .
      dockerfile: docker/api_gateway.Dockerfile
    container_name: vokg-api-prod
    env_file:
      - .env
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      NEO4J_URI: bolt://neo4j:7687
      S3_ENDPOINT_URL: http://minio:9000
      DEBUG: "False"
      ENVIRONMENT: production
    volumes:
      - upload_temp:/tmp/vokg
    networks:
      - vokg-network
    depends_on:
      - postgres
      - redis
      - neo4j
      - minio
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    command: >
      sh -c "alembic upgrade head &&
             gunicorn backend.api_gateway.main:app
             -w 4
             -k uvicorn.workers.UvicornWorker
             --bind 0.0.0.0:8000
             --access-logfile -
             --error-logfile -"
    restart: always

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: vokg-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    networks:
      - vokg-network
    depends_on:
      - api
    restart: always

  # CPU workers (scaled)
  worker-cpu:
    build:
      context: .
      dockerfile: docker/worker.Dockerfile
    env_file:
      - .env
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      NEO4J_URI: bolt://neo4j:7687
      S3_ENDPOINT_URL: http://minio:9000
    volumes:
      - worker_temp:/tmp/vokg
    networks:
      - vokg-network
    depends_on:
      - postgres
      - redis
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    command: >
      celery -A backend.core.celery_app worker
      --loglevel=info
      --queues=cpu,default
      --concurrency=4
      --max-tasks-per-child=50
    restart: always

  # GPU worker (single instance)
  worker-gpu:
    build:
      context: .
      dockerfile: docker/gpu_worker.Dockerfile
    env_file:
      - .env
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      NEO4J_URI: bolt://neo4j:7687
      S3_ENDPOINT_URL: http://minio:9000
      NVIDIA_VISIBLE_DEVICES: all
    volumes:
      - ./models:/models:ro
      - worker_temp:/tmp/vokg
    networks:
      - vokg-network
    depends_on:
      - postgres
      - redis
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    command: >
      celery -A backend.core.celery_app worker
      --loglevel=info
      --queues=gpu
      --concurrency=1
      --max-tasks-per-child=10
    restart: always

  # LLM workers (scaled)
  worker-llm:
    build:
      context: .
      dockerfile: docker/worker.Dockerfile
    env_file:
      - .env
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      S3_ENDPOINT_URL: http://minio:9000
    networks:
      - vokg-network
    depends_on:
      - postgres
      - redis
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    command: >
      celery -A backend.core.celery_app worker
      --loglevel=info
      --queues=llm
      --concurrency=2
      --max-tasks-per-child=20
    restart: always

  # Graph workers
  worker-graph:
    build:
      context: .
      dockerfile: docker/worker.Dockerfile
    env_file:
      - .env
    environment:
      POSTGRES_HOST: postgres
      REDIS_HOST: redis
      NEO4J_URI: bolt://neo4j:7687
      S3_ENDPOINT_URL: http://minio:9000
    networks:
      - vokg-network
    depends_on:
      - postgres
      - redis
      - neo4j
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    command: >
      celery -A backend.core.celery_app worker
      --loglevel=info
      --queues=graph
      --concurrency=2
      --max-tasks-per-child=30
    restart: always

networks:
  vokg-network:
    driver: bridge

volumes:
  postgres_data:
  neo4j_data:
  neo4j_logs:
  redis_data:
  minio_data:
  upload_temp:
  worker_temp:
